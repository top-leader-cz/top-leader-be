# This workflow will build a Java project with Gradle, and cache/restore any dependencies to improve the workflow execution time
name: Build/Deploy top-leader-be

on:
  push:
    tags:
      - 'qa-deploy'
      - 'qa-deploy-*'
      - 'release-v*.*.*'
  pull_request:
    branches: [ "develop", "main" ]

jobs:
  build:
    if: github.event_name == 'pull_request'
    runs-on: ubuntu-latest
    steps:
    - uses: actions/checkout@v4

    - name: Set up JDK 25
      uses: actions/setup-java@v4
      with:
        java-version: '25'
        distribution: 'corretto'
        cache: gradle

    - name: Setup Gradle
      uses: gradle/actions/setup-gradle@v4
      with:
        cache-read-only: ${{ github.ref != 'refs/heads/main' }}

    - name: Build and verify coverage (min 80%)
      run: gradle build jacocoTestReport jacocoTestCoverageVerification --parallel --build-cache


  deploy-qa:
    if: github.event_name == 'push' && startsWith(github.ref, 'refs/tags/qa-deploy')
    runs-on: ubuntu-latest
    env:
      REGION: europe-west3
      SERVICE_NAME: top-leader-qa
      PROJECT_ID: topleader-394306
      IMAGE_NAME: top-leader-be
    steps:
      - uses: actions/checkout@v4

      - name: Cloud Authentication
        uses: google-github-actions/auth@v2
        with:
          credentials_json: ${{ secrets.GCP_CREDENTIALS }}

      - name: Set up Cloud SDK
        uses: google-github-actions/setup-gcloud@v2

      - name: Configure Docker for Artifact Registry
        run: gcloud auth configure-docker ${{ env.REGION }}-docker.pkg.dev

      - name: Build and push Docker image
        run: |
          SHORT_SHA=$(git rev-parse --short "$GITHUB_SHA")
          IMAGE_URL=${{ env.REGION }}-docker.pkg.dev/${{ env.PROJECT_ID }}/top-leader/${{ env.IMAGE_NAME }}
          docker build -t ${IMAGE_URL}:${SHORT_SHA} -t ${IMAGE_URL}:latest .
          docker push ${IMAGE_URL}:${SHORT_SHA}
          docker push ${IMAGE_URL}:latest

      - name: Deploy to Cloud Run QA
        run: |
          SHORT_SHA=$(git rev-parse --short "$GITHUB_SHA")
          IMAGE_URL=${{ env.REGION }}-docker.pkg.dev/${{ env.PROJECT_ID }}/top-leader/${{ env.IMAGE_NAME }}:${SHORT_SHA}

          # Update image tag in service YAML
          sed -i "s|image:.*|image: ${IMAGE_URL}|" src/main/cloudrun/service-qa.yaml

          # Deploy using service YAML
          gcloud run services replace src/main/cloudrun/service-qa.yaml \
            --region=${{ env.REGION }} \
            --project=${{ env.PROJECT_ID }}

          # Allow unauthenticated access
          gcloud run services add-iam-policy-binding ${{ env.SERVICE_NAME }} \
            --region=${{ env.REGION }} \
            --member="allUsers" \
            --role="roles/run.invoker" \
            --project=${{ env.PROJECT_ID }}

      - name: Cleanup old revisions (keep last 3)
        run: |
          echo "Fetching QA revisions..."
          REVISIONS=$(gcloud run revisions list \
            --service=${{ env.SERVICE_NAME }} \
            --region=${{ env.REGION }} \
            --platform=managed \
            --sort-by=~metadata.creationTimestamp \
            --format="value(metadata.name)" \
            --project=${{ env.PROJECT_ID }} | tail -n +4)

          if [ -z "$REVISIONS" ]; then
            echo "No old revisions to delete"
          else
            echo "Deleting old revisions: $REVISIONS"
            for REVISION in $REVISIONS; do
              gcloud run revisions delete $REVISION \
                --region=${{ env.REGION }} \
                --platform=managed \
                --project=${{ env.PROJECT_ID }} \
                --quiet || echo "Failed to delete $REVISION"
            done
          fi

  deploy-prod:
    if: github.event_name == 'push' && startsWith(github.ref, 'refs/tags/release-v')
    runs-on: ubuntu-latest
    permissions:
      contents: write
    env:
      SPRING_DATASOURCE_PASSWORD: ${{ secrets.SPRING_DATASOURCE_PASSWORD_PROD }}
      SPRING_MAIL_PASSWORD: ${{ secrets.SPRING_MAIL_PASSWORD }}
      TOP_LEADER_CALENDLY_CLIENT_SECRETS: ${{ secrets.TOP_LEADER_CALENDLY_CLIENT_SECRETS }}
      GOOGLE_CLIENT_CLIENT_SECRET: ${{ secrets.GOOGLE_CLIENT_CLIENT_SECRET }}
      SPRING_AI_OPENAI_APIKEY: ${{ secrets.SPRING_AI_OPENAI_APIKEY }}
      GRAFANA_OTLP_TOKEN: ${{ secrets.GRAFANA_OTLP_TOKEN }}
      JOB_TRIGGER_PASSWORD: ${{ secrets.JOB_TRIGGER_PASSWORD }}
    steps:
      - uses: actions/checkout@v4

      - name: Replace repository-secrets in app-prod.yaml
        run: |
          envsubst < src/main/appengine/app-prod.yaml > src/main/appengine/app-prod.yaml.tmp
          mv src/main/appengine/app-prod.yaml.tmp src/main/appengine/app-prod.yaml

      - name: Set up JDK 25
        uses: actions/setup-java@v4
        with:
          java-version: '25'
          distribution: 'temurin'
          cache: gradle

      - name: Setup Gradle
        uses: gradle/actions/setup-gradle@v4
        with:
          cache-read-only: false

      - name: Cloud Authentication
        uses: google-github-actions/auth@v2
        with:
          credentials_json: ${{ secrets.GCP_CREDENTIALS }}

      - name: Build Application
        run: gradle bootJar -x test --parallel --build-cache

      - name: Copy JAR to appengine directory
        run: cp build/libs/top-leader.jar src/main/appengine/

      - name: Deploy to App Engine PROD
        run: gcloud app deploy src/main/appengine/app-prod.yaml --project=topleader-394306 --version=$(git rev-parse --short "$GITHUB_SHA") --promote --quiet

      - name: Cleanup old PROD versions (keep last 2)
        run: |
          echo "Fetching PROD versions..."
          VERSIONS=$(gcloud app versions list \
            --service=prod \
            --project=topleader-394306 \
            --sort-by=~version.createTime \
            --format="value(version.id)" | tail -n +3)

          if [ -z "$VERSIONS" ]; then
            echo "No old versions to delete"
          else
            echo "Deleting old versions: $VERSIONS"
            for VERSION in $VERSIONS; do
              gcloud app versions delete $VERSION \
                --service=prod \
                --project=topleader-394306 \
                --quiet || echo "Failed to delete $VERSION"
            done
          fi

      - name: Create GitHub Release with changelog
        env:
          GH_TOKEN: ${{ github.token }}
        run: |
          TAG_NAME="${GITHUB_REF#refs/tags/}"
          gh release create "$TAG_NAME" \
            --title "$TAG_NAME" \
            --generate-notes
