# This workflow will build a Java project with Gradle, and cache/restore any dependencies to improve the workflow execution time
name: Build/Deploy top-leader-be

on:
  push:
    tags:
      - 'qa-deploy'
      - 'qa-deploy-*'
      - 'release-v*.*.*'
  pull_request:
    branches: [ "develop", "main" ]

jobs:
  build:
    if: github.event_name == 'pull_request'
    runs-on: ubuntu-latest
    steps:
    - uses: actions/checkout@v4

    - name: Set up JDK 25
      uses: actions/setup-java@v4
      with:
        java-version: '25'
        distribution: 'corretto'
        cache: gradle

    - name: Setup Gradle
      uses: gradle/actions/setup-gradle@v4
      with:
        cache-read-only: ${{ github.ref != 'refs/heads/main' }}

    - name: Build with Gradle
      run: gradle build --parallel --build-cache


  deploy-qa:
    if: github.event_name == 'push' && startsWith(github.ref, 'refs/tags/qa-deploy')
    runs-on: ubuntu-latest
    env:
      SPRING_DATASOURCE_PASSWORD: ${{ secrets.SPRING_DATASOURCE_PASSWORD_QA }}
      SPRING_MAIL_PASSWORD: ${{ secrets.SPRING_MAIL_PASSWORD }}
      TOP_LEADER_CALENDLY_CLIENT_SECRETS: ${{ secrets.TOP_LEADER_CALENDLY_CLIENT_SECRETS }}
      GOOGLE_CLIENT_CLIENT_SECRET: ${{ secrets.GOOGLE_CLIENT_CLIENT_SECRET }}
      SPRING_AI_OPENAI_APIKEY: ${{ secrets.SPRING_AI_OPENAI_APIKEY }}
      GRAFANA_OTLP_TOKEN: ${{ secrets.GRAFANA_OTLP_TOKEN }}
      JOB_TRIGGER_PASSWORD: ${{ secrets.JOB_TRIGGER_PASSWORD }}
    steps:
      - uses: actions/checkout@v4

      - name: Replace repository-secrets in app-qa.yaml
        run: |
          envsubst < src/main/appengine/app-qa.yaml > src/main/appengine/app-qa.yaml.tmp
          mv src/main/appengine/app-qa.yaml.tmp src/main/appengine/app-qa.yaml

      - name: Set up JDK 25
        uses: actions/setup-java@v4
        with:
          java-version: '25'
          distribution: 'temurin'
          cache: gradle

      - name: Setup Gradle
        uses: gradle/actions/setup-gradle@v4
        with:
          cache-read-only: false

      - name: Cloud Authentication
        uses: google-github-actions/auth@v2
        with:
          credentials_json: ${{ secrets.GCP_CREDENTIALS }}

      - name: Generate OpenAPI spec
        run: gradle generateOpenApi

      - name: Build JAR
        run: gradle bootJar --parallel --build-cache

      - name: Copy JAR to appengine directory
        run: cp build/libs/top-leader.jar src/main/appengine/

      - name: Deploy to App Engine QA
        run: gcloud app deploy src/main/appengine/app-qa.yaml --project=topleader-394306 --version=$(git rev-parse --short "$GITHUB_SHA") --promote --verbosity=debug

      - name: Cleanup old QA versions (keep last 2)
        run: |
          echo "Fetching QA versions..."
          VERSIONS=$(gcloud app versions list \
            --service=qa \
            --project=topleader-394306 \
            --sort-by=~version.createTime \
            --format="value(version.id)" | tail -n +3)

          if [ -z "$VERSIONS" ]; then
            echo "No old versions to delete"
          else
            echo "Deleting old versions: $VERSIONS"
            for VERSION in $VERSIONS; do
              gcloud app versions delete $VERSION \
                --service=qa \
                --project=topleader-394306 \
                --quiet || echo "Failed to delete $VERSION"
            done
          fi

  deploy-prod:
    if: github.event_name == 'push' && startsWith(github.ref, 'refs/tags/release-v')
    runs-on: ubuntu-latest
    permissions:
      contents: write
    env:
      SPRING_DATASOURCE_PASSWORD: ${{ secrets.SPRING_DATASOURCE_PASSWORD_PROD }}
      SPRING_MAIL_PASSWORD: ${{ secrets.SPRING_MAIL_PASSWORD }}
      TOP_LEADER_CALENDLY_CLIENT_SECRETS: ${{ secrets.TOP_LEADER_CALENDLY_CLIENT_SECRETS }}
      GOOGLE_CLIENT_CLIENT_SECRET: ${{ secrets.GOOGLE_CLIENT_CLIENT_SECRET }}
      SPRING_AI_OPENAI_APIKEY: ${{ secrets.SPRING_AI_OPENAI_APIKEY }}
      GRAFANA_OTLP_TOKEN: ${{ secrets.GRAFANA_OTLP_TOKEN }}
      JOB_TRIGGER_PASSWORD: ${{ secrets.JOB_TRIGGER_PASSWORD }}
    steps:
      - uses: actions/checkout@v4

      - name: Replace repository-secrets in app-prod.yaml
        run: |
          envsubst < src/main/appengine/app-prod.yaml > src/main/appengine/app-prod.yaml.tmp
          mv src/main/appengine/app-prod.yaml.tmp src/main/appengine/app-prod.yaml

      - name: Set up JDK 25
        uses: actions/setup-java@v4
        with:
          java-version: '25'
          distribution: 'temurin'
          cache: gradle

      - name: Setup Gradle
        uses: gradle/actions/setup-gradle@v4
        with:
          cache-read-only: false

      - name: Cloud Authentication
        uses: google-github-actions/auth@v2
        with:
          credentials_json: ${{ secrets.GCP_CREDENTIALS }}

      - name: Generate OpenAPI spec
        run: gradle generateOpenApi

      - name: Build Application
        run: gradle bootJar -x test --parallel --build-cache

      - name: Copy JAR to appengine directory
        run: cp build/libs/top-leader.jar src/main/appengine/

      - name: Deploy to App Engine PROD
        run: gcloud app deploy src/main/appengine/app-prod.yaml --project=topleader-394306 --version=$(git rev-parse --short "$GITHUB_SHA") --promote --quiet

      - name: Cleanup old PROD versions (keep last 2)
        run: |
          echo "Fetching PROD versions..."
          VERSIONS=$(gcloud app versions list \
            --service=prod \
            --project=topleader-394306 \
            --sort-by=~version.createTime \
            --format="value(version.id)" | tail -n +3)

          if [ -z "$VERSIONS" ]; then
            echo "No old versions to delete"
          else
            echo "Deleting old versions: $VERSIONS"
            for VERSION in $VERSIONS; do
              gcloud app versions delete $VERSION \
                --service=prod \
                --project=topleader-394306 \
                --quiet || echo "Failed to delete $VERSION"
            done
          fi

      - name: Create GitHub Release with changelog
        env:
          GH_TOKEN: ${{ github.token }}
        run: |
          TAG_NAME="${GITHUB_REF#refs/tags/}"
          gh release create "$TAG_NAME" \
            --title "$TAG_NAME" \
            --generate-notes
